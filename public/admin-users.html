<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - User Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body ng-app="userAdminApp" ng-controller="userAdminController" ng-init="fetchAllUsers()">
    <nav class="navbar navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand"><i class="fa-solid fa-handshake"></i> promo.com</a>
            <div>
              <a href="/admin-dash.html" class="btn btn-secondary">Back to Dashboard</a>
              <button class="btn btn-outline-danger" id="btnLogout">Logout</button>
            </div>
        </div>
    </nav>

    <div id="indash" class="text-center">USER MANAGEMENT</div>

    <div class="container mt-4">
      <h3 class="mb-3">All Registered Users</h3>
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>S.No</th>
                    <th>Email</th>
                    <th>User Type</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr ng-repeat="user in allUsers">
                    <td>{{$index + 1}}</td>
                    <td>{{user.email}}</td>
                    <td>{{user.utype}}</td>
                    <td>
                        <span class="badge" ng-class="{'bg-success': user.status == 1, 'bg-danger': user.status == 0}">
                            {{user.status == 1 ? 'Active' : 'Blocked'}}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm" ng-class="{'btn-warning': user.status == 1, 'btn-info': user.status == 0}" ng-click="toggleUserStatus(user.email, user.status)">
                            {{user.status == 1 ? 'Block' : 'Resume'}}
                        </button>
                        <button class="btn btn-sm btn-danger ms-2" ng-click="deleteUser(user.email)">Delete</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        $(document).ready(function() {
            $("#btnLogout").click(function() {
                $.ajax({ url: "/api/logout", method: "POST" }).done(() => location.href = "/");
            });
        });

        var app = angular.module('userAdminApp', []);
        app.controller('userAdminController', function($scope, $http) {
            $scope.allUsers = [];

            $scope.fetchAllUsers = function() {
                $http.get("/api/admin/users").then(function(response) {
                    $scope.allUsers = response.data;
                }, function(error){
                    if(error.status === 403 || error.status === 401) location.href = "/adminpage.html";
                    else alert("Failed to fetch users.");
                });
            };

            $scope.deleteUser = function(email) {
                if (!confirm("Are you sure you want to delete the user " + email + "? This action cannot be undone.")) {
                    return;
                }
                $http.delete("/api/admin/users/" + email).then(function(response) {
                    alert(response.data.message);
                    $scope.fetchAllUsers();
                }, function(error){
                    alert(error.data.message || "Failed to delete user.");
                });
            };

            $scope.toggleUserStatus = function(email, currentStatus) {
                const newStatus = currentStatus == 1 ? 0 : 1;
                const action = newStatus == 1 ? 'resume' : 'block';
                if (!confirm("Are you sure you want to " + action + " the user " + email + "?")) {
                    return;
                }
                $http.put("/api/admin/users/" + email + "/status", { status: newStatus }).then(function(response) {
                    alert(response.data.message);
                    $scope.fetchAllUsers();
                }, function(error){
                    alert(error.data.message || "Failed to update status.");
                });
            };
        });
    </script>
</body>
</html>